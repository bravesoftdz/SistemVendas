unit U_pdv;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ComCtrls, Data.DB, Vcl.StdCtrls,
  Vcl.Grids, Vcl.DBGrids, Vcl.ExtCtrls, Vcl.Mask, RxToolEdit, RxCurrEdit,
  Vcl.Buttons, FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, FireDAC.Comp.DataSet, FireDAC.Comp.Client;

type
  TF_PDV = class(TForm)
    stb_pdv: TStatusBar;
    pn_pdv_baixo: TPanel;
    dbg_lançamento_pdv: TDBGrid;
    edt_pro_barras_pdv: TEdit;
    edt_pro_nome_pdv: TEdit;
    edt_pro_preco_pdv: TCurrencyEdit;
    edt_pro_prazo_pdv: TCurrencyEdit;
    edt_pro_qtd_pdv: TCurrencyEdit;
    edt_total_pdv: TCurrencyEdit;
    edt_total_prazo_pdv: TCurrencyEdit;
    lbl_total_pn_baixo_pdv: TLabel;
    ldb_total_prazol_pn_baixo_pdv: TLabel;
    edt_cli_codigo_pdv: TEdit;
    edt_cli_nome_pdv: TEdit;
    lbl_buscarporbarras_pdv: TLabel;
    lbl_buscar_clientes_pdv: TLabel;
    lbl_qtd_pdv: TLabel;
    lbl_buscarpornome_pdv: TLabel;
    pn_btns_iconis_pdv: TPanel;
    pn_principal: TPanel;
    pn_buscar_clientes: TPanel;
    pn_buscar_barras_nome_pdv: TPanel;
    pn_btn_iniciar_venda_pdv: TPanel;
    pn_btns_grv_can_fec_vendas_pdv: TPanel;
    DBGrid1: TDBGrid;
    lbl_cod_cliente: TLabel;
    lbl_cpf_cnpj_cli_pdv: TLabel;
    lbl_cel_cli_pdv: TLabel;
    lbl_resut_cpf_cnpj_cli_pdv: TLabel;
    lbl_result_cel_cli_pdv: TLabel;
    lbl_end_cli_pdv: TLabel;
    lbl_result_end_cli_pdv: TLabel;
    lbl_qtd_estoq_pro_pdv: TLabel;
    lbl_result_qtd_estoque_prod_pdv: TLabel;
    lbl_total_pro_pdv: TLabel;
    lbl_total_prazo_pro_pdv: TLabel;
    SQL_verifica_venda: TFDQuery;
    ds_pedidos: TDataSource;
    SQL_itens_add: TFDQuery;
    btn_iniciar_venda_pdv: TBitBtn;
    btn_pro_iten_add_pdv: TBitBtn;
    btn_pro_iten_remove_pdv: TBitBtn;
    btn_venda_gravar_pdv: TBitBtn;
    btn_venda_fechar_pdv: TBitBtn;
    btn_venda_cancelar_pdv: TBitBtn;
    btn_impressao_pdv: TBitBtn;
    btn_venda_sair_pdv: TBitBtn;
    SQL_listar_pedidos_dbglançamento: TFDQuery;
    SQL_listar_pedidos_dbglançamentoped_id: TFDAutoIncField;
    SQL_listar_pedidos_dbglançamentoped_date: TDateField;
    SQL_listar_pedidos_dbglançamentoped_codigo: TStringField;
    SQL_listar_pedidos_dbglançamentoped_cliente: TIntegerField;
    SQL_listar_pedidos_dbglançamentoped_usuario: TIntegerField;
    SQL_listar_pedidos_dbglançamentoped_forma_pag: TIntegerField;
    SQL_listar_pedidos_dbglançamentoped_fechado: TStringField;
    SQL_listar_pedidos_dbglançamentoped_faturado: TStringField;
    SQL_listar_pedidos_dbglançamentopro_id: TIntegerField;
    SQL_listar_pedidos_dbglançamentopro_nome: TStringField;
    SQL_listar_pedidos_dbglançamentopro_barra: TStringField;
    SQL_listar_pedidos_dbglançamentopro_ref: TStringField;
    SQL_listar_pedidos_dbglançamentopro_custo: TFloatField;
    SQL_listar_pedidos_dbglançamentopro_preco: TFloatField;
    SQL_listar_pedidos_dbglançamentopro_preco_prazo: TFloatField;
    SQL_listar_pedidos_dbglançamentopro_estoque: TIntegerField;
    SQL_listar_pedidos_dbglançamentoiten_id: TIntegerField;
    SQL_listar_pedidos_dbglançamentoiten_produto: TIntegerField;
    SQL_listar_pedidos_dbglançamentoiten_qtd: TIntegerField;
    SQL_listar_pedidos_dbglançamentoiten_pedido: TStringField;
    SQL_listar_pedidos_dbglançamentoiten_preco: TFloatField;
    SQL_listar_pedidos_dbglançamentoiten_preco_prazo: TFloatField;
    SQL_listar_pedidos_dbglançamentosubTotal: TFloatField;
    SQL_listar_pedidos_dbglançamentosubTotalPrazo: TFloatField;
    SQL_Listar_Pedidos_dbg2: TFDQuery;
    ds_pedidos2: TDataSource;
    TB_pedidos: TFDTable;
    TB_pedidosped_id: TFDAutoIncField;
    TB_pedidosped_date: TDateField;
    TB_pedidosped_codigo: TStringField;
    TB_pedidosped_cliente: TIntegerField;
    TB_pedidosped_usuario: TIntegerField;
    TB_pedidosped_forma_pag: TIntegerField;
    TB_pedidosped_fechado: TStringField;
    TB_pedidosped_faturado: TStringField;
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure edt_cli_codigo_pdvKeyPress(Sender: TObject; var Key: Char);
    procedure edt_pro_barras_pdvKeyPress(Sender: TObject; var Key: Char);
    procedure edt_pro_nome_pdvKeyPress(Sender: TObject; var Key: Char);
    procedure edt_cli_nome_pdvKeyPress(Sender: TObject; var Key: Char);
    procedure ProcedureBuscaProduto;
    procedure ProcedureBloqueiacampos;
    procedure ProcedureDesbloqueiaCampos;
    procedure ProcedureIniciaVenda;
    procedure ProcedureProdutosAdd;
    procedure ProcedureAtualizaDBGridLançamentos;
    procedure edt_pro_nome_pdvKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure edt_pro_barras_pdvKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure edt_cli_nome_pdvKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure edt_cli_codigo_pdvKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure edt_cli_codigo_pdvChange(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure btn_iniciar_venda_pdvClick(Sender: TObject);
    procedure edt_cli_nome_pdvChange(Sender: TObject);
    procedure edt_pro_qtd_pdvKeyPress(Sender: TObject; var Key: Char);
    procedure btn_pro_iten_add_pdvClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btn_pro_iten_add_pdv2Click(Sender: TObject);
    procedure btn_venda_sair_pdvClick(Sender: TObject);
    procedure SQL_listar_pedidos_dbglançamentoCalcFields(DataSet: TDataSet);
    procedure edt_pro_qtd_pdvKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure btn_pro_iten_remove_pdvClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  codigo_venda : string;
  total_pedido, total_pedido_prazo : Double;
  end;

var
  F_PDV: TF_PDV;

implementation

uses
  U_clientes, u_DM, U_PesquisarProduto, U_funcoes, U_PesquisarCliente;

{$R *.dfm}

procedure TF_PDV.ProcedureAtualizaDBGridLançamentos;
begin
   SQL_listar_pedidos_dbglançamento.Close;
   SQL_listar_pedidos_dbglançamento.Open;


   SQL_listar_pedidos_dbglançamento.First;
   total_pedido :=0;
   total_pedido_prazo :=0;
   while not SQL_listar_pedidos_dbglançamento.Eof do //enquanto não terminar os registros
   begin
   total_pedido := total_pedido + SQL_listar_pedidos_dbglançamentosubTotal.Value;
   total_pedido_prazo := total_pedido_prazo + SQL_listar_pedidos_dbglançamentosubTotalPrazo.Value;

   SQL_listar_pedidos_dbglançamento.Next;
   end;

   edt_total_pdv.Value := total_pedido;
   edt_total_prazo_pdv.Value := total_pedido_prazo;

end;


procedure TF_PDV.ProcedureProdutosAdd;
var produto, qtd :Integer;
var preco, preco_prazo :Double;
begin
    if edt_pro_qtd_pdv.Value < 0 then
     begin
       ShowMessage('Quantidade Incorreta!');
       Exit;
     end;

    if (edt_pro_barras_pdv.Text = '') and (edt_pro_nome_pdv.Text = '') then
    begin
      ShowMessage('Precisa informar os dados do produto!');
      edt_pro_nome_pdv.SetFocus;
      Exit;
    end;


       with dm.SQL_produtos do
        begin
          Close;
          SQL.Clear;
          SQL.Add('select * from produtos');
          SQL.Add('where pro_nome = :nome');
          SQL.Add('and pro_barra = :barra');
          ParamByName('barra').Value := edt_pro_barras_pdv.Text;
          ParamByName('nome').Value := edt_pro_nome_pdv.Text;
          Open;
              begin
                  if RecordCount = 0 then
                   ShowMessage('Produto não encontrado!');
                   edt_pro_barras_pdv.Clear ;
                   edt_pro_nome_pdv.Clear;
                   edt_pro_preco_pdv.Clear;
                   edt_pro_prazo_pdv.Clear;
                   edt_pro_nome_pdv.SetFocus ;
               end;

                begin
                   if RecordCount = 1 then

                   begin
                      produto     := dm.SQL_produtospro_id.Value;
                      qtd         := StrToInt(edt_pro_qtd_pdv.Text);
                      preco       := dm.SQL_produtospro_preco.Value;
                      preco_prazo := dm.SQL_produtospro_preco_prazo.Value;

                      with SQL_itens_add do
                      begin
                      Close;
                      SQL.Clear;
                      SQL.Add('select * from itens');
                      SQL.Add('where iten_produto = :produto');
                      SQL.Add('and iten_pedido = :pedido');
                      ParamByName('produto').Value  := produto;
                      ParamByName('pedido').Value   := codigo_venda;
                      Open;

                        if SQL_itens_add.RecordCount > 0 then
                          begin
                          //
                            with SQL_itens_add do
                            begin
                            Close;
                            SQL.Clear;
                            SQL.Add('update itens set iten_qtd = iten_qtd + :qtd');
                            SQL.Add('where iten_produto = :produto and iten_pedido = :pedido');
                            ParamByName('pedido').Value := codigo_venda;
                            ParamByName('produto').Value := produto;
                            ParamByName('qtd').Value := qtd;
                            ExecSQL;
                            end;
                          end

                        else
                              begin
                                   with SQL_itens_add do
                                    begin
                                        Close;
                                        SQL.Clear;
                                        SQL.Add('insert into itens ');
                                        SQL.Add('(iten_produto, iten_qtd, iten_pedido, iten_preco, iten_preco_prazo)');
                                        SQL.Add('values( :produto,:qtd,:pedido,:preco, :preco_prazo)');
                                        //SQL.Add('select * from itens');
                                        //SQL.Add('where iten_produto = produto');
                                        ParamByName('produto').Value := produto;
                                        ParamByName('qtd').Value := qtd;
                                        ParamByName('pedido').Value :=  codigo_venda;
                                        ParamByName('preco').Value := preco;
                                        ParamByName('preco_prazo').Value :=  preco_prazo;
                                        ExecSQL;

                                        ShowMessage('Produto Adiocionado!');
                                        edt_pro_nome_pdv.SetFocus;
                                    end;
                              end;

                               edt_pro_qtd_pdv.Value := 1;
                              ProcedureAtualizaDBGridLançamentos;
                      end;


                   end;

                end;

        end;

end;



procedure TF_PDV.SQL_listar_pedidos_dbglançamentoCalcFields(DataSet: TDataSet);
begin
    SQL_listar_pedidos_dbglançamentosubTotal.Value :=
    SQL_listar_pedidos_dbglançamentopro_preco.Value * SQL_listar_pedidos_dbglançamentoiten_qtd.Value;

    SQL_listar_pedidos_dbglançamentosubTotalPrazo.Value :=
    SQL_listar_pedidos_dbglançamentopro_preco_prazo.Value * SQL_listar_pedidos_dbglançamentoiten_qtd.Value;
end;

procedure TF_PDV.ProcedureIniciaVenda;
begin
   ProcedureDesbloqueiaCampos;
   if codigo_venda = '' then
   begin
   codigo_venda := FormatDateTime('yymmdd', Date) + FormatDateTime('hhmmss', Time);
   end;

   F_PDV.Caption := 'Pedido '+ codigo_venda;
   with SQL_verifica_venda do
   begin
   Close;
   SQL.Clear;
   SQL.Add('select * from pedidos');
   SQL.Add('where ped_codigo = :codigo');
   ParamByName('codigo').Value := codigo_venda;
   Open;

   end;

   if SQL_verifica_venda.RecordCount = 0 then
   begin
      TB_pedidos.Active;
      TB_pedidos.Append;
      TB_pedidosped_date.Value := Date;
      TB_pedidosped_codigo.AsString := codigo_venda;
      TB_pedidosped_cliente.Value := dm.SQL_clientescli_id.Value;
      TB_pedidosped_usuario.Value := 1;
      TB_pedidosped_fechado.AsString := 'NAO';
      TB_pedidosped_faturado.AsString:= 'NAO';
      TB_pedidos.Post;
   end;

  with SQL_listar_pedidos_dbglançamento do
   begin
   Close;
   SQL.Clear;
   SQL.Add('select* from view_listar_pedidos');
   SQL.Add('where ped_codigo = :codigo');
   ParamByName('codigo').Value := codigo_venda;
   Open;

   end;

end;
procedure TF_PDV.ProcedureBloqueiacampos;
begin
   btn_iniciar_venda_pdv.Visible:= False;
   edt_pro_nome_pdv.Visible:=False;
   edt_pro_barras_pdv.Visible:=false;
   edt_pro_qtd_pdv.Visible:=False;
   dbg_lançamento_pdv.Visible:=False;
   //pn_btns_grv_can_fec_vendas_pdv.Visible:=False;
   btn_venda_gravar_pdv.Visible:=False;
   btn_venda_fechar_pdv.Visible:=False;
   btn_venda_cancelar_pdv.Visible:=False;
   btn_pro_iten_add_pdv.Visible:=False;
   btn_pro_iten_remove_pdv.Visible:=false;
   edt_cli_codigo_pdv.Visible:=False;
end;

 procedure TF_PDV.ProcedureDesbloqueiaCampos;
begin
   edt_cli_codigo_pdv.Visible:=True;
   edt_cli_nome_pdv.Visible:=True;
   edt_pro_nome_pdv.Visible:=True;
   edt_pro_barras_pdv.Visible:=True;
   edt_pro_qtd_pdv.Visible:=True;
   dbg_lançamento_pdv.Visible:=True;
   //pn_btns_grv_can_fec_vendas_pdv.Visible:=True;
   btn_venda_gravar_pdv.Visible:=True;
   btn_venda_fechar_pdv.Visible:=True;
   btn_venda_cancelar_pdv.Visible:=True;
   btn_pro_iten_add_pdv.Visible:=True;
   btn_pro_iten_remove_pdv.Visible:=True
end;

procedure TF_PDV.ProcedureBuscaProduto;
begin
    if Length(edt_pro_barras_pdv.Text) = 13 then
    with dm.SQL_produtos do
    begin
      Close;
      SQL.Clear;
      SQL.Add('select * from produtos');
      SQL.Add('where pro_barra = :barra');
      ParamByName('barra').Value := edt_pro_barras_pdv.Text;
      Open;
      begin


          begin
              if RecordCount = 0 then
               ShowMessage('Produto não encontrado!');
               edt_pro_barras_pdv.Clear;
          end;

          begin
            if RecordCount = 1 then
            edt_pro_barras_pdv.Text := dm.SQL_produtospro_barra.AsString;
            edt_pro_nome_pdv.Text := dm.SQL_produtospro_nome.AsString;
            lbl_result_qtd_estoque_prod_pdv.Caption := dm.SQL_produtospro_estoque.AsString;
          end;

         end;
    end;


end;

procedure TF_PDV.edt_cli_codigo_pdvChange(Sender: TObject);
begin
   if edt_cli_codigo_pdv.Text <> ' ' then
   btn_iniciar_venda_pdv.Visible := true;
  edt_cli_codigo_pdv.SelectAll;
end;

procedure TF_PDV.edt_cli_codigo_pdvKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
     case Key of
      VK_F2:
          begin
            F_pdv_clientes_listar := TF_pdv_clientes_listar.Create(self);
            F_pdv_clientes_listar.ShowModal;

          end;

      end;
end;

procedure TF_PDV.edt_cli_codigo_pdvKeyPress(Sender: TObject; var Key: Char);
begin
    if Key = #13 then
    with dm.SQL_clientes do
      begin

        Close;
        SQL.Clear;
        SQL.Add('select * from clientes');
        SQL.Add('where cli_id = :id');
        ParamByName('id').Value:= edt_cli_codigo_pdv.Text;
        Open;
             begin

                  begin
                     if RecordCount = 0 then
                    ShowMessage('Cliente não encontrato!');
                    edt_cli_codigo_pdv.Clear;
                    edt_cli_nome_pdv.Clear;
                    btn_iniciar_venda_pdv.Visible:=False;

                  end;

                 begin
                   if RecordCount = 1 then
                   edt_cli_codigo_pdv.Text := dm.SQL_clientescli_id.AsString;
                   edt_cli_nome_pdv.Text := dm.SQL_clientescli_nome.AsString;
                   lbl_resut_cpf_cnpj_cli_pdv.Caption := dm.SQL_clientescli_cnpj_cpf.AsString;
                   lbl_result_cel_cli_pdv.Caption := dm.SQL_clientescli_celular.AsString;
                   lbl_result_end_cli_pdv.Caption := dm.SQL_clientescli_endereco.AsString +'  Nº '+ dm.SQL_clientescli_numero.AsString + ' '+ dm.SQL_clientescli_bairro.AsString;
                   edt_cli_codigo_pdv.SelectAll;
                 end

             end;





      end;
end;

procedure TF_PDV.edt_cli_nome_pdvChange(Sender: TObject);
begin
     if dm.SQL_clientes.RecordCount = 1 then
     btn_iniciar_venda_pdv.Visible := true;
     edt_cli_codigo_pdv.SelectAll;
end;

procedure TF_PDV.edt_cli_nome_pdvKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
     case Key of
      VK_F2:
          begin
            F_pdv_clientes_listar := TF_pdv_clientes_listar.Create(self);
            F_pdv_clientes_listar.ShowModal;

          end;

      end;

    

end;

procedure TF_PDV.edt_cli_nome_pdvKeyPress(Sender: TObject; var Key: Char);
begin
     if Key = #13 then
      begin
         if edt_cli_nome_pdv.Text = '' then
                ShowMessage('Campo vazio!')
              else
              begin
                    with dm.SQL_clientes do
                 begin
                   Close;
                   SQL.Clear;
                   SQL.Add('select * from clientes');
                   SQL.Add('where cli_nome like :nome');
                   ParamByName('nome').Value := edt_cli_nome_pdv.Text + '%';
                   Open;
                   begin
                       if RecordCount = 0 then
                        ShowMessage('Cliente não encontrado!');
                        edt_cli_nome_pdv.Clear;
                        edt_cli_codigo_pdv.Clear;
                        btn_iniciar_venda_pdv.Visible:=False;
                   end;

                   begin
                     if RecordCount = 1 then
                     edt_cli_nome_pdv.Text := dm.SQL_clientescli_nome.AsString;
                     edt_cli_codigo_pdv.Text := dm.SQL_clientescli_id.AsString;
                     lbl_resut_cpf_cnpj_cli_pdv.Caption := dm.SQL_clientescli_cnpj_cpf.AsString;
                     lbl_result_cel_cli_pdv.Caption := dm.SQL_clientescli_celular.AsString;
                     lbl_result_end_cli_pdv.Caption := dm.SQL_clientescli_endereco.AsString +'  Nº '+ dm.SQL_clientescli_numero.AsString + ' '+ dm.SQL_clientescli_bairro.AsString;
                     edt_cli_nome_pdv.SelectAll;

                   end;

               end;
              end;


          end;
end;

procedure TF_PDV.edt_pro_barras_pdvKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin


  case Key of
  VK_F2:
  begin
    F_pdv_produtos_listar := TF_pdv_produtos_listar.Create(self);
    F_pdv_produtos_listar.ShowModal;
  end;

  end;
end;

procedure TF_PDV.edt_pro_barras_pdvKeyPress(Sender: TObject; var Key: Char);
begin


    If Key = #13  then

        with dm.SQL_produtos do
        begin
          Close;
          SQL.Clear;
          SQL.Add('select * from produtos');
          SQL.Add('where pro_barra = :barra');
          ParamByName('barra').Value := edt_pro_barras_pdv.Text;
          Open;
          begin


              begin
                  if RecordCount = 0 then
                   ShowMessage('Produto não encontrado!');
                   edt_pro_barras_pdv.Clear ;
                   edt_pro_nome_pdv.Clear;
                   edt_pro_preco_pdv.Clear;
                   edt_pro_prazo_pdv.Clear;
                   edt_pro_barras_pdv.SetFocus ;

                    exit
                 end;

              begin
                if RecordCount = 1 then
                edt_pro_barras_pdv.Text := dm.SQL_produtospro_barra.AsString;
                edt_pro_nome_pdv.Text := dm.SQL_produtospro_nome.AsString;
                lbl_result_qtd_estoque_prod_pdv.Caption := dm.SQL_produtospro_estoque.AsString;
                edt_pro_qtd_pdv.SetFocus;
                edt_pro_qtd_pdv.SelectAll;

                end ;
             end;


        end;


       begin
        //permitir digitar somente números positivos no código de barras
        if not (Key in['0'..'9',Chr(8)]) then
        Key:= #0
        end;


end;

procedure TF_PDV.edt_pro_nome_pdvKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  case Key of
  VK_F2:
  begin
    F_pdv_produtos_listar := TF_pdv_produtos_listar.Create(self);
    F_pdv_produtos_listar.ShowModal;
    edt_pro_qtd_pdv.SetFocus;
  end;

  end;


end;

procedure TF_PDV.edt_pro_nome_pdvKeyPress(Sender: TObject; var Key: Char);
begin

    if Key = #13 then
      begin
         if edt_pro_nome_pdv.Text = '' then
                ShowMessage('Campo vazio!')
              else
              begin
                  with dm.SQL_produtos do
               begin
                 Close;
                 SQL.Clear;
                 SQL.Add('select * from produtos');
                 SQL.Add('where pro_nome like  :nome');
                 ParamByName('nome').Value := edt_pro_nome_pdv.Text + '%';
                 Open;
                 begin
                     if RecordCount = 0 then
                      ShowMessage('Produto não encontrado!');
                      edt_pro_nome_pdv.Clear;
                      edt_pro_barras_pdv.Clear;
                 end;

                 begin
                   if RecordCount = 1 then
                   edt_pro_nome_pdv.SelectAll;
                   edt_pro_nome_pdv.Text := dm.SQL_produtospro_nome.AsString;
                   edt_pro_barras_pdv.Text := dm.SQL_produtospro_barra.AsString;
                   edt_pro_preco_pdv.Value := dm.SQL_produtospro_preco.Value;
                   edt_pro_prazo_pdv.Value := dm.SQL_produtospro_preco_prazo.Value;
                   lbl_result_qtd_estoque_prod_pdv.Caption := dm.SQL_produtospro_estoque.AsString;
                   edt_pro_qtd_pdv.SetFocus;
                   edt_pro_qtd_pdv.SelectAll;
                 end;

               end;
              end;


          end;

           begin
           //não digitar números na pesquisa por nome do produto
           if not (Key in['a'..'z','A'..'Z',Chr(8)]) then
           Key:= #0
           end;
end;

procedure TF_PDV.edt_pro_qtd_pdvKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
    if Key = VK_TAB then
    btn_pro_iten_add_pdv.SetFocus;
end;

procedure TF_PDV.edt_pro_qtd_pdvKeyPress(Sender: TObject; var Key: Char);
begin

  if Key = #13 then
  btn_pro_iten_add_pdv.Click;

   begin
        //permitir digitar somente números positivos no código de barras
        if not (Key in['0'..'9',Chr(8)]) then
        Key:= #0
        end;


end;

procedure TF_PDV.FormClose(Sender: TObject; var Action: TCloseAction);
begin
    SQL_listar_pedidos_dbglançamento.Close;
    codigo_venda := '';
    dm.SQL_produtos.Close;
    F_PDV:= nil;
end;

procedure TF_PDV.FormCreate(Sender: TObject);
begin
   ProcedureBloqueiacampos;
end;

procedure TF_PDV.FormShow(Sender: TObject);
begin
   edt_cli_nome_pdv.SetFocus;
end;



procedure TF_PDV.btn_iniciar_venda_pdvClick(Sender: TObject);
begin
  ProcedureIniciavenda;
  edt_pro_nome_pdv.SetFocus;
end;

procedure TF_PDV.btn_pro_iten_add_pdv2Click(Sender: TObject);
begin
  ProcedureProdutosAdd;
end;

procedure TF_PDV.btn_pro_iten_add_pdvClick(Sender: TObject);
begin
  ProcedureProdutosAdd;
end;



procedure TF_PDV.btn_pro_iten_remove_pdvClick(Sender: TObject);
var produto, qtd, qtd_existente : Integer;
begin
    produto :=  SQL_listar_pedidos_dbglançamentoiten_id.Value;
    qtd_existente := SQL_listar_pedidos_dbglançamentoiten_qtd.Value;

    if qtd_existente > 1 then
    begin
      qtd:= StrToInt(InputBox('Digite a quantidade','Quantos itens deseja remover?','1'));
    end;
    //qtd := 1;

   with SQL_itens_add do
    begin
    //remove a quantidade da do campo QTD
     Close;
     SQL.Clear;
     SQL.Add('update itens set iten_qtd = iten_qtd - :qtd');
     SQL.Add('where iten_id = :produto and iten_pedido = :pedido');
     ParamByName('pedido').Value := codigo_venda;
     ParamByName('produto').Value := produto;
     ParamByName('qtd').Value := qtd;
     ExecSQL;

    end;

       with SQL_itens_add do
      begin
      //deleta o iten se a QTD = 0
       Close;
       SQL.Clear;
       SQL.Add('delete from itens');
       SQL.Add('where iten_qtd = 0');
       ExecSQL;

      end;

    ProcedureAtualizaDBGridLançamentos;
end;

procedure TF_PDV.btn_venda_sair_pdvClick(Sender: TObject);
begin
   Close;
   F_PDV := nil;
end;

end.
